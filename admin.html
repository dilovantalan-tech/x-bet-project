<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-BET - Admin Control Panel</title>
    <!-- Include Sync System -->
    <script src="sync.js"></script>
    <style>
        /* [Keep all your existing CSS styles] */
        /* ... existing CSS ... */
    </style>
</head>
<body>
    <!-- [Keep all your existing HTML structure] -->
    <!-- ... existing HTML ... -->

    <script>
        // üî• UPDATED ADMIN PANEL - Uses Universal Sync
        class AdminPanel {
            constructor() {
                this.currentAdmin = null;
                this.adminData = null;
                this.allUsers = [];
                this.allTransactions = [];
                this.adminBalance = 14050000.00;
                this.syncCheckInterval = null;
            }

            init() {
                console.log("=== ADMIN PANEL (Universal Sync) ===");
                this.checkAdminAuth();
                this.loadAdminData();
                this.initializeSyncSystem();
                this.loadAllUsers();
                this.loadAllTransactions();
                this.updateDisplay();
                this.setupEventListeners();
                this.saveAdminData();
            }

            checkAdminAuth() {
                const adminSession = localStorage.getItem('admin_session');
                const adminUser = localStorage.getItem('admin_user');
                
                if (!adminSession || !adminUser) {
                    window.location.href = 'admin.login.html';
                    return;
                }
                
                try {
                    this.currentAdmin = adminUser;
                    document.getElementById('adminUsername').textContent = this.currentAdmin;
                } catch (error) {
                    console.error('Session error:', error);
                    window.location.href = 'admin.login.html';
                }
            }

            loadAdminData() {
                this.adminData = JSON.parse(localStorage.getItem('admin_data_' + this.currentAdmin) || '{}');
                
                if (!this.adminData.balance) {
                    this.adminData.balance = 14050000.00;
                }
                
                if (!this.adminData.transactions) this.adminData.transactions = [];
                if (!this.adminData.users) this.adminData.users = [];
                
                this.adminBalance = this.adminData.balance;
            }
            
            // üî• INITIALIZE SYNC SYSTEM
            initializeSyncSystem() {
                console.log('Initializing admin sync system...');
                
                if (!window.xbetSync) {
                    console.error('Sync system not loaded!');
                    alert('‚ö†Ô∏è Sync system not loaded. Users may not appear.');
                    return;
                }
                
                // Force immediate sync on startup
                window.xbetSync.syncNow();
                
                // Setup sync check every 3 seconds
                this.syncCheckInterval = setInterval(() => {
                    this.checkForNewUsers();
                }, 3000);
                
                // Add sync status display
                this.addSyncStatusDisplay();
            }
            
            // üî• CHECK FOR NEW USERS FROM SYNC
            checkForNewUsers() {
                const oldCount = this.allUsers.length;
                this.loadAllUsers(); // This now uses sync system
                
                if (this.allUsers.length > oldCount) {
                    console.log(`üÜï New users detected! ${oldCount} ‚Üí ${this.allUsers.length}`);
                    this.updateDisplay();
                    
                    // Show notification
                    this.showNotification(`New user registered! Total: ${this.allUsers.length}`);
                }
            }
            
            // üî• ADD SYNC STATUS DISPLAY
            addSyncStatusDisplay() {
                setTimeout(() => {
                    const statsGrid = document.querySelector('.admin-stats-grid');
                    if (statsGrid && window.xbetSync) {
                        const status = window.xbetSync.getSyncStatus();
                        
                        const syncCard = document.createElement('div');
                        syncCard.className = 'admin-stat-card';
                        syncCard.innerHTML = `
                            <div class="stat-header">
                                <div class="stat-title">Sync Status</div>
                                <div class="stat-icon" style="background: rgba(139, 92, 246, 0.2);">üîÑ</div>
                            </div>
                            <div class="stat-value stat-primary" id="syncStatus">Active</div>
                            <div style="color: #94a3b8; font-size: 0.9rem;">
                                Browser: ${status.browser}<br>
                                Users: ${status.universalUsers}
                            </div>
                        `;
                        statsGrid.appendChild(syncCard);
                    }
                }, 1000);
            }
            
            // üî• LOAD ALL USERS FROM SYNC SYSTEM
            loadAllUsers() {
                console.log("Loading users from sync system...");
                
                if (window.xbetSync) {
                    // Get users from universal sync system
                    const syncedUsers = window.xbetSync.getAllUsers();
                    
                    // Convert to admin format
                    this.allUsers = syncedUsers.map(user => ({
                        username: user.username,
                        email: user.email,
                        balance: user.balance || 0,
                        gameBalance: user.gameBalance || 0,
                        transactionCode: user.transactionCode || window.xbetSync.generateTransactionCode(user.username),
                        status: user.status || 'active',
                        registeredAt: user.registeredAt || new Date().toISOString(),
                        lastLogin: user.lastLogin || new Date().toISOString(),
                        isAdmin: false,
                        source: user.source || 'universal_sync'
                    }));
                    
                    console.log(`‚úÖ Loaded ${this.allUsers.length} users from sync system`);
                } else {
                    // Fallback to local storage
                    console.warn('Sync system not available, using local storage');
                    const localUsers = JSON.parse(localStorage.getItem('ALL_XBET_USERS') || '[]');
                    this.allUsers = localUsers.map(user => ({
                        username: user.username,
                        email: user.email,
                        balance: user.balance || 0,
                        gameBalance: user.gameBalance || 0,
                        transactionCode: user.transactionCode,
                        status: user.status || 'active',
                        registeredAt: user.registeredAt || new Date().toISOString(),
                        isAdmin: false,
                        source: 'local_storage'
                    }));
                }
                
                // Update UI
                this.updateUsersTable();
                this.updateUserCodesDatalist();
            }
            
            updateUserCodesDatalist() {
                const datalist = document.getElementById('userCodes');
                if (datalist) {
                    datalist.innerHTML = this.allUsers.map(user => 
                        `<option value="${user.transactionCode}">${user.username} (${user.email}) - $${user.balance.toFixed(2)}</option>`
                    ).join('');
                }
            }

            loadAllTransactions() {
                this.allTransactions = [];
                
                // Load from all users
                for (const user of this.allUsers) {
                    const userData = JSON.parse(localStorage.getItem('userData_' + user.username) || '{}');
                    if (userData.activities) {
                        userData.activities.forEach(activity => {
                            this.allTransactions.push({
                                ...activity,
                                user: user.username,
                                date: activity.date || new Date().toISOString(),
                                isAdmin: false
                            });
                        });
                    }
                }
                
                // Load admin transactions
                if (this.adminData.transactions) {
                    this.adminData.transactions.forEach(transaction => {
                        this.allTransactions.push({
                            ...transaction,
                            user: this.currentAdmin,
                            isAdmin: true
                        });
                    });
                }
                
                // Sort by date
                this.allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                this.updateTransactionsDisplay();
            }

            updateDisplay() {
                const formattedBalance = new Intl.NumberFormat('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(this.adminBalance);
                
                document.getElementById('adminBalance').textContent = `$${formattedBalance}`;
                document.getElementById('totalBalance').textContent = `$${formattedBalance}`;
                document.getElementById('totalUsers').textContent = this.allUsers.length;
                document.getElementById('totalTransactions').textContent = this.allTransactions.length;
                
                // Update user count badge
                const badge = document.getElementById('userCountBadge');
                if (badge) {
                    badge.textContent = `${this.allUsers.length} users`;
                }
                
                // Calculate game balance
                const totalGameBalance = this.allUsers.reduce((sum, user) => sum + (user.gameBalance || 0), 0);
                const gameBalanceEl = document.getElementById('totalGameBalance');
                if (gameBalanceEl) {
                    gameBalanceEl.textContent = `$${totalGameBalance.toFixed(2)}`;
                }
                
                // Update sync status
                const syncStatusEl = document.getElementById('syncStatus');
                if (syncStatusEl && window.xbetSync) {
                    const status = window.xbetSync.getSyncStatus();
                    syncStatusEl.textContent = status.syncActive ? 'Active' : 'Inactive';
                    syncStatusEl.style.color = status.syncActive ? '#10b981' : '#ef4444';
                }
            }

            updateUsersTable() {
                const tbody = document.getElementById('usersTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                if (this.allUsers.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 3rem; color: #94a3b8;">
                                <div style="margin-bottom: 1rem;">No users found yet.</div>
                                <div style="font-size: 0.9rem;">
                                    ‚ö†Ô∏è <strong>Note:</strong> Users from ALL browsers will appear here automatically.<br>
                                    Make sure sync.js is loaded and working.
                                </div>
                                <button onclick="admin.forceSync()" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; margin-top: 1rem; cursor: pointer;">
                                    üîÑ Force Sync Now
                                </button>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                this.allUsers.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            ${user.username}
                            ${user.source === 'universal_sync' ? '<span style="font-size: 0.7em; color: #8b5cf6; margin-left: 5px;">üîÑ</span>' : ''}
                        </td>
                        <td>${user.email}</td>
                        <td>$${(user.balance || 0).toFixed(2)}</td>
                        <td>$${(user.gameBalance || 0).toFixed(2)}</td>
                        <td><span class="transaction-code">${user.transactionCode}</span></td>
                        <td><span style="color: ${user.status === 'active' ? '#10b981' : '#ef4444'}">${user.status}</span></td>
                        <td>
                            <button class="user-action-btn" onclick="admin.viewUser('${user.username}')">View</button>
                            <button class="user-action-btn" onclick="admin.depositToUser('${user.username}')">Deposit</button>
                            <button class="user-action-btn" onclick="admin.withdrawFromUser('${user.username}')">Withdraw</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            updateTransactionsDisplay(filter = 'all') {
                const container = document.getElementById('transactionsLog');
                if (!container) return;
                
                let transactions = this.allTransactions;
                
                if (filter !== 'all') {
                    transactions = transactions.filter(t => 
                        (filter === 'game' && (t.type === 'game_credit' || t.type === 'game_debit')) ||
                        (!t.isAdmin && t.type === filter)
                    );
                }
                
                if (transactions.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #94a3b8;">
                            No transactions found
                        </div>
                    `;
                    return;
                }
                
                const recentTransactions = transactions.slice(0, 30);
                
                container.innerHTML = recentTransactions.map(transaction => {
                    const amount = transaction.amount || 0;
                    const isPositive = amount >= 0;
                    const typeClass = transaction.type === 'game_credit' || transaction.type === 'game_debit' ? 'transaction-game' : 
                                   transaction.isAdmin ? 'transaction-admin' : `transaction-${transaction.type}`;
                    const amountClass = isPositive ? 'stat-positive' : 'stat-negative';
                    const amountSign = isPositive ? '+' : '-';
                    const userPrefix = transaction.isAdmin ? 'üëë ' : 'üë§ ';
                    const typeIcon = transaction.type === 'game_credit' ? 'üéÆ+' :
                                   transaction.type === 'game_debit' ? 'üéÆ-' :
                                   transaction.type === 'deposit' ? 'üí∞' : 
                                   transaction.type === 'withdrawal' ? 'üí∏' : 'üîÑ';
                    
                    return `
                        <div class="transaction-item ${typeClass}">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">
                                    ${typeIcon} ${userPrefix}${transaction.user} ‚Ä¢ ${transaction.title || transaction.type}
                                </div>
                                <div style="font-size: 0.85rem; color: #94a3b8;">
                                    ${new Date(transaction.date).toLocaleString()}
                                    ${transaction.code ? ` ‚Ä¢ Code: <span class="transaction-code">${transaction.code}</span>` : ''}
                                    ${transaction.description ? ` ‚Ä¢ ${transaction.description}` : ''}
                                </div>
                            </div>
                            <div class="stat-value ${amountClass}" style="font-size: 1.1rem;">
                                ${amountSign}$${Math.abs(amount).toFixed(2)}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // User actions
            viewUser(username) {
                const user = this.allUsers.find(u => u.username === username);
                if (user) {
                    const userData = JSON.parse(localStorage.getItem('userData_' + username) || '{}');
                    const activities = userData.activities || [];
                    
                    let info = `üë§ User Details:\n\n`;
                    info += `Username: ${user.username}\n`;
                    info += `Email: ${user.email}\n`;
                    info += `Main Balance: $${user.balance.toFixed(2)}\n`;
                    info += `Game Balance: $${(user.gameBalance || 0).toFixed(2)}\n`;
                    info += `Transaction Code: ${user.transactionCode}\n`;
                    info += `Status: ${user.status}\n`;
                    info += `Registered: ${new Date(user.registeredAt).toLocaleString()}\n`;
                    info += `Source: ${user.source || 'local'}\n`;
                    info += `Total Transactions: ${activities.length}\n\n`;
                    
                    if (activities.length > 0) {
                        info += `Recent Transactions:\n`;
                        activities.slice(0, 5).forEach(activity => {
                            const sign = activity.amount >= 0 ? '+' : '-';
                            info += `- ${activity.type}: ${sign}$${Math.abs(activity.amount).toFixed(2)} (${activity.status})\n`;
                        });
                    }
                    
                    alert(info);
                }
            }

            depositToUser(username) {
                const user = this.allUsers.find(u => u.username === username);
                if (user) {
                    document.getElementById('depositUserCode').value = user.transactionCode;
                    openDepositModal();
                }
            }

            withdrawFromUser(username) {
                const user = this.allUsers.find(u => u.username === username);
                if (user) {
                    const amount = prompt(`Enter withdrawal amount for ${username} (Max: $${user.balance.toFixed(2)}):`, "10");
                    if (amount && parseFloat(amount) > 0 && parseFloat(amount) <= user.balance) {
                        document.getElementById('userTransactionCode').value = user.transactionCode;
                        document.getElementById('transferAmount').value = amount;
                        document.getElementById('transferType').value = 'withdrawal';
                    } else if (amount) {
                        alert('Invalid amount or insufficient balance');
                    }
                }
            }
            
            searchUsers(query) {
                if (!query) {
                    this.updateUsersTable();
                    return;
                }
                
                const filteredUsers = this.allUsers.filter(user => 
                    user.username.toLowerCase().includes(query.toLowerCase()) ||
                    user.email.toLowerCase().includes(query.toLowerCase()) ||
                    user.transactionCode.toLowerCase().includes(query.toLowerCase())
                );
                
                const tbody = document.getElementById('usersTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                filteredUsers.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.username}</td>
                        <td>${user.email}</td>
                        <td>$${user.balance.toFixed(2)}</td>
                        <td>$${(user.gameBalance || 0).toFixed(2)}</td>
                        <td><span class="transaction-code">${user.transactionCode}</span></td>
                        <td><span style="color: ${user.status === 'active' ? '#10b981' : '#ef4444'}">${user.status}</span></td>
                        <td>
                            <button class="user-action-btn" onclick="admin.viewUser('${user.username}')">View</button>
                            <button class="user-action-btn" onclick="admin.depositToUser('${user.username}')">Deposit</button>
                            <button class="user-action-btn" onclick="admin.withdrawFromUser('${user.username}')">Withdraw</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            filterTransactions(type) {
                this.updateTransactionsDisplay(type);
            }

            // üî• FORCE SYNC FUNCTION
            forceSync() {
                if (window.xbetSync) {
                    const result = window.xbetSync.syncNow();
                    if (result.success) {
                        this.loadAllUsers();
                        this.updateDisplay();
                        this.showNotification(`Force sync completed! ${result.message}`);
                    } else {
                        alert(`Sync failed: ${result.error}`);
                    }
                } else {
                    alert('Sync system not loaded!');
                }
            }
            
            // üî• SHOW NOTIFICATION
            showNotification(message) {
                // Create notification element
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #10b981;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 10px;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                    z-index: 9999;
                    animation: slideIn 0.3s ease;
                `;
                
                // Add animation
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
                
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;">üîî</span>
                        <div>${message}</div>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    notification.style.animation = 'slideIn 0.3s ease reverse';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            }

            // Process admin transfer
            async processAdminTransfer() {
                const userCode = document.getElementById('userTransactionCode').value.trim();
                const amount = parseFloat(document.getElementById('transferAmount').value);
                const type = document.getElementById('transferType').value;
                
                if (!userCode) {
                    alert('Please enter user transaction code');
                    return;
                }
                
                if (!amount || amount <= 0) {
                    alert('Please enter a valid amount (minimum $0.01)');
                    return;
                }
                
                // Find user
                const user = this.allUsers.find(u => 
                    u.transactionCode.toUpperCase() === userCode.toUpperCase()
                );
                
                if (!user) {
                    alert('User not found with this transaction code');
                    return;
                }
                
                let userData = JSON.parse(localStorage.getItem('userData_' + user.username) || '{}');
                if (!userData.activities) userData.activities = [];
                
                const transactionCode = 'TXN-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6).toUpperCase();
                
                if (type === 'deposit') {
                    if (this.adminBalance < amount) {
                        alert('Admin has insufficient balance');
                        return;
                    }
                    
                    const oldBalance = user.balance;
                    user.balance += amount;
                    this.adminBalance -= amount;
                    this.adminData.balance = this.adminBalance;
                    
                    userData.balance = user.balance;
                    userData.activities.push({
                        id: 'TXN-' + Date.now(),
                        type: 'deposit',
                        amount: amount,
                        date: new Date().toISOString(),
                        code: transactionCode,
                        title: 'Admin Deposit',
                        description: 'Deposit from admin',
                        status: 'completed',
                        category: 'received'
                    });
                    
                    this.adminData.transactions.push({
                        id: 'TXN-' + Date.now(),
                        type: 'transfer',
                        amount: -amount,
                        date: new Date().toISOString(),
                        code: transactionCode,
                        title: 'Deposit to User',
                        description: `Deposit to ${user.username}`,
                        status: 'completed'
                    });
                    
                    alert(`‚úÖ Deposit successful!\n\nAmount: $${amount.toFixed(2)}\nTo: ${user.username}\nUser new balance: $${user.balance.toFixed(2)}`);
                    
                } else if (type === 'withdrawal') {
                    if (user.balance < amount) {
                        alert('User has insufficient balance');
                        return;
                    }
                    
                    const oldBalance = user.balance;
                    user.balance -= amount;
                    this.adminBalance += amount;
                    this.adminData.balance = this.adminBalance;
                    
                    userData.balance = user.balance;
                    userData.activities.push({
                        id: 'TXN-' + Date.now(),
                        type: 'withdrawal',
                        amount: -amount,
                        date: new Date().toISOString(),
                        code: transactionCode,
                        title: 'Admin Withdrawal',
                        description: 'Withdrawal by admin',
                        status: 'completed',
                        category: 'sent'
                    });
                    
                    this.adminData.transactions.push({
                        id: 'TXN-' + Date.now(),
                        type: 'transfer',
                        amount: amount,
                        date: new Date().toISOString(),
                        code: transactionCode,
                        title: 'Withdrawal from User',
                        description: `Withdrawal from ${user.username}`,
                        status: 'completed'
                    });
                    
                    alert(`‚úÖ Withdrawal successful!\n\nAmount: $${amount.toFixed(2)}\nFrom: ${user.username}\nUser new balance: $${user.balance.toFixed(2)}`);
                }
                
                // Save data
                localStorage.setItem('userData_' + user.username, JSON.stringify(userData));
                this.saveAdminData();
                
                // Update sync system
                if (window.xbetSync) {
                    window.xbetSync.registerUser({
                        username: user.username,
                        email: user.email,
                        balance: user.balance,
                        gameBalance: user.gameBalance,
                        transactionCode: user.transactionCode,
                        status: user.status
                    });
                }
                
                // Clear form
                document.getElementById('userTransactionCode').value = '';
                document.getElementById('transferAmount').value = '';
                
                // Refresh
                this.loadAllUsers();
                this.loadAllTransactions();
                this.updateDisplay();
            }

            saveAdminData() {
                localStorage.setItem('admin_data_' + this.currentAdmin, JSON.stringify(this.adminData));
            }

            setupEventListeners() {
                // Auto-refresh
                setInterval(() => {
                    this.loadAllUsers();
                    this.loadAllTransactions();
                    this.updateDisplay();
                }, 5000);
            }
        }

        // Initialize Admin Panel
        const admin = new AdminPanel();
        admin.init();

        // Add Force Sync button to admin actions
        setTimeout(() => {
            const actionsDiv = document.querySelector('.admin-actions');
            if (actionsDiv) {
                const forceSyncBtn = document.createElement('button');
                forceSyncBtn.className = 'admin-action-btn sync';
                forceSyncBtn.innerHTML = 'üîÑ Force Sync All Browsers';
                forceSyncBtn.onclick = () => {
                    admin.forceSync();
                };
                actionsDiv.appendChild(forceSyncBtn);
                
                // Add sync status button
                const syncStatusBtn = document.createElement('button');
                syncStatusBtn.className = 'admin-action-btn';
                syncStatusBtn.style.background = 'linear-gradient(135deg, #8b5cf6, #7c3aed)';
                syncStatusBtn.innerHTML = 'üìä Sync Status';
                syncStatusBtn.onclick = () => {
                    if (window.xbetSync) {
                        const status = window.xbetSync.getSyncStatus();
                        alert(`Sync System Status:\n\nBrowser: ${status.browser}\nUniversal Users: ${status.universalUsers}\nLocal Users: ${status.localUsers}\nLast Sync: ${status.lastSync}\nSync Active: ${status.syncActive ? 'Yes' : 'No'}`);
                    } else {
                        alert('Sync system not loaded!');
                    }
                };
                actionsDiv.appendChild(syncStatusBtn);
            }
        }, 1500);

        // [Keep all your existing modal functions]
        // ... existing modal functions ...
    </script>
</body>
</html>
